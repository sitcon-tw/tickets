---
import * as i18n from "src/i18n";
import { Copy } from "@lucide/astro";
const lang = i18n.local(Astro.url.pathname);
const t = i18n.t(lang, {
	description: {
		"zh-Hant": "毛哥EM的網站起始模板，使用Astro和Fastify構建。",
		"zh-Hans": "毛哥EM的网站起始模板，使用Astro和Fastify构建。",
		en: "Elvis Mao's Website starter template using Astro and Fastify."
	},
	loggedInWelcome: {
		"zh-Hant": "歡迎回來！",
		"zh-Hans": "欢迎回来！",
		en: "Welcome back!"
	},
	registeredWelcome: {
		"zh-Hant": "你已完成報名！",
		"zh-Hans": "你已完成报名！",
		en: "Registration Complete!"
	},
	inviteCode: {
		"zh-Hant": "歡迎使用以下優惠碼邀請朋友一起參加：",
		"zh-Hans": "欢迎使用以下优惠码邀请朋友一起参加：",
		en: "Use this code to invite friends:"
	},
	referralWelcome: {
		"zh-Hant": "邀請你一起參加 SITCON！",
		"zh-Hans": "邀请你一起参加 SITCON！",
		en: "invites you to join SITCON!"
	},
	inviteTicket: {
		"zh-Hant": "你收到了一張講者邀請票！",
		"zh-Hans": "你收到了一张讲者邀请票！",
		en: "You received a speaker invitation!"
	},
	registerNow: {
		"zh-Hant": "立即報名",
		"zh-Hans": "立即报名",
		en: "Register Now"
	},
	selectTicket: {
		"zh-Hant": "請選擇你要的票種",
		"zh-Hans": "请选择你要的票种",
		en: "Please select your ticket type"
	}
});
---

<!-- Welcome section for registered users -->
<section id="registered-welcome" class="welcome-section" style="display: none;">
	<h2>{t.registeredWelcome}</h2>
	<p>{t.inviteCode}</p>
	<div class="code"><div id="referral-code">載入中...</div><Copy size="18" /></div>
</section>

<!-- Welcome section for referral -->
<section id="referral-welcome" class="welcome-section" style="display: none;">
	<h2><span id="referrer-name">XXX</span> {t.referralWelcome}</h2>
	<p>累積三人一起報名即可獲得一張柴柴簽名照。</p>
</section>

<!-- Welcome section for invitation ticket -->
<section id="invitation-welcome" class="welcome-section" style="display: none;">
	<h2>{t.inviteTicket}</h2>
	<a class="button" href="#" id="invitation-register-btn">{t.registerNow}</a>
</section>

<!-- Default welcome for logged in users -->
<section id="default-welcome" class="welcome-section" style="display: none;">
	<h2>{t.loggedInWelcome}</h2>
</section>

<h2 id="select">{t.selectTicket}</h2>

<script is:inline>
	// Handle welcome section display based on user status
	async function handleWelcomeSection() {
		try {
			// Get URL parameters
			const urlParams = new URLSearchParams(window.location.search);
			const referralCode = urlParams.get("ref");
			const invitationCode = urlParams.get("invite");

			// Check authentication status
			const response = await fetch("http://localhost:3000/api/auth/get-session", {
				credentials: "include"
			});

			if (response.ok) {
				const session = await response.json();

				if (session && session.user) {
					// User is authenticated
					// Check if user has registered for any event
					try {
						const registrationsResponse = await fetch("http://localhost:3000/api/registrations", {
							credentials: "include"
						});

						if (registrationsResponse.ok) {
							const registrations = await registrationsResponse.json();

							if (registrations.success && registrations.data && registrations.data.length > 0) {
								// User is registered, show referral code
								showRegisteredWelcome();
								return;
							}
						}
					} catch (error) {
						console.error("Failed to check registrations:", error);
					}

					// User is logged in but not registered
					if (invitationCode) {
						showInvitationWelcome();
					} else if (referralCode) {
						showReferralWelcome();
					} else {
						showDefaultWelcome();
					}
				} else {
					// User is not authenticated
					if (referralCode) {
						showReferralWelcome();
					} else if (invitationCode) {
						showInvitationWelcome();
					}
					// If no special parameters and not authenticated, don't show welcome section
				}
			}
		} catch (error) {
			console.error("Failed to handle welcome section:", error);
		}
	}

	function showRegisteredWelcome() {
		document.getElementById("registered-welcome").style.display = "block";

		// Load user's referral code
		loadReferralCode();

		// Add copy functionality
		document.querySelector(".code").addEventListener("click", copyReferralCode);
	}

	function showReferralWelcome() {
		const urlParams = new URLSearchParams(window.location.search);
		const referralCode = urlParams.get("ref");
		if (referralCode) {
			// Store referral code for later use
			sessionStorage.setItem("referralCode", referralCode);
		}
		document.getElementById("referral-welcome").style.display = "block";
	}

	function showInvitationWelcome() {
		const urlParams = new URLSearchParams(window.location.search);
		const invitationCode = urlParams.get("invite");
		if (invitationCode) {
			// Store invitation code for later use
			sessionStorage.setItem("invitationCode", invitationCode);
		}
		document.getElementById("invitation-welcome").style.display = "block";

		// Add click handler for registration button
		document.getElementById("invitation-register-btn").addEventListener("click", e => {
			e.preventDefault();
			const params = new URLSearchParams();
			if (invitationCode) {
				params.set("invite", invitationCode);
			}
			window.location.href = `/form/?${params.toString()}`;
		});
	}

	function showDefaultWelcome() {
		//document.getElementById('default-welcome').style.display = 'block';
	}

	async function loadReferralCode() {
		try {
			const response = await fetch("http://localhost:3000/api/referrals", {
				credentials: "include"
			});

			if (response.ok) {
				const referralData = await response.json();
				if (referralData.success && referralData.data && referralData.data.code) {
					document.getElementById("referral-code").textContent = referralData.data.code;
				}
			}
		} catch (error) {
			console.error("Failed to load referral code:", error);
			document.getElementById("referral-code").textContent = "載入失敗";
		}
	}

	function copyReferralCode() {
		const code = document.getElementById("referral-code").textContent;
		if (code && code !== "載入中..." && code !== "載入失敗") {
			navigator.clipboard.writeText(code).then(() => {
				alert("推薦碼已複製到剪貼簿！");
			});
		}
	}

	// Initialize when DOM is loaded
	document.addEventListener("DOMContentLoaded", handleWelcomeSection);
</script>

<style>
	.welcome-section {
		background-color: var(--color-gray-800);
		padding: 2rem;
		margin: 1rem;
		text-align: center;
	}
	.code {
		background-color: var(--color-gray-700);
		padding: 0.5rem;
		max-width: 10rem;
		margin: 1rem auto 0;
		display: flex;
		justify-content: space-between;
		align-items: center;
		cursor: pointer;
		transition: background-color 0.2s;
	}

	.code:hover {
		background-color: var(--color-gray-600);
	}

	#referral-code {
		text-align: center;
		flex: 1;
		font-weight: bold;
	}

	.lucide-copy {
		opacity: 0.7;
	}

	.welcome-section h2 {
		font-size: 1.5rem;
		margin-bottom: 0.5rem;
	}

	#select {
		font-size: 1rem;
		margin-block: 2rem;
		text-align: center;
		font-weight: normal;
		animation: blink 1s infinite linear alternate;
		opacity: 0.8;
	}

	@keyframes blink {
		to {
			opacity: 0.1;
		}
	}
	.button {
		margin: 1rem auto 0;
	}
</style>
