---
title: 監控與觀測
description: OpenTelemetry、Prometheus、Tempo 與 Grafana 整合說明
---

## OpenTelemetry

- `backend/lib/tracing.js` 於進程啟動即初始化 NodeSDK：
  - 匯出 OTLP HTTP (`OTEL_EXPORTER_OTLP_ENDPOINT`，預設 `http://tempo:4318/v1/traces`)
  - 自動掛載 Node.js / Fastify / HTTP Instrumentation
  - 透過 `withSpan()`、`createSpan()` 進行手動追蹤
- 排除路徑：`/health`, `/metrics`
- `serviceName`: `tickets-backend`

## Prometheus 指標

- 套件：`fastify-metrics`
- 端點：`/metrics`
- 預設內容：Node.js 預設指標、HTTP Route 指標（已啟用 `routeMetrics`）
- 可於 Grafana 中使用 `http_request_duration_seconds_bucket` 等指標觀察延遲

## Grafana/Tempo 範本

- 根目錄 `grafana.yaml` 提供 Zeabur 模板設定：
  - `prometheus`：抓取 `backend:3000/metrics`
  - `tempo`：接收 OTLP Trace
  - `grafana`：預設資料源已綁定 Prometheus 與 Tempo
- 部署此模板後於 Grafana 建立 Dashboard / Trace Explorer

## 推薦儀表板

1. **API Latency & Error**：依 `le` bucket 畫出 P95、P99 延遲
2. **Magic Link 流量**：使用自訂 Span Tag 或 status code 統計
3. **Database Load**：可補強 Prisma Metrics 或以 Tracing 觀察 SQL duration

## 本地測試

- 以 docker-compose 或 Zeabur 部署 `grafana.yaml` 內三個服務
- 後端 `.env` 設定 `OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318/v1/traces`
- 確保防火牆允許 4318, 9090, 3200, 3000 等埠

## 日誌整合

- Fastify logger 預設輸出 JSON（`logger: true` + level `error`）
- 若需收集結構化日誌，可導向 Loki 或第三方服務
- 建議保留追蹤 ID（`traceparent` header）於反向代理，以利串接 trace 與 log
