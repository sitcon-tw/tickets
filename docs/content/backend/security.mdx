---
title: 安全與驗證
description: Rate limit、CORS、BetterAuth 與資料清洗策略
---

## Rate Limit 設定

`config/security.js` 定義兩組限制：

| 設定     | 預設值            | 說明                                               |
| -------- | ----------------- | -------------------------------------------------- |
| `global` | 10 分鐘 30,000 次 | 套用於所有一般請求，允許本機私網段在開發模式下略過 |
| `auth`   | 10 分鐘 20,000 次 | 專用於 `/api/auth/*`，自訂錯誤回應 `請求過於頻繁`  |

> 可透過環境變數 `RATE_LIMIT_MAX`, `RATE_LIMIT_WINDOW`, `AUTH_RATE_LIMIT_MAX` 覆寫。

## Helmet 與 CORS

- Helmet CSP 限制 Script/Style 來源為自身與 `https://font.emtech.cc`
- 啟用 HSTS、`frameguard: deny`、`noSniff` 等常見安全標頭
- CORS 僅允許 `FRONTEND_URI`, `BACKEND_URI`，開發模式額外允許 `localhost` 與 `127.*`
- 開放的 Header 包含 `CF-*`、`X-Forwarded-*` 以支援 Cloudflare/反向代理

## 驗證機制

### BetterAuth + Magic Link

`lib/auth.js` 使用 BetterAuth + `magicLink` 外掛，流程：

1. `/api/auth/*` 請求由 `app.js` 轉交給 BetterAuth handler。
2. 送出魔術連結前檢查：
   - 同 email 30 秒內不可重複請求
   - 自上次成功後最多 3 次失敗
   - 單日成功登入不得超過 20 次
   - 單一 IP 單日上限 50 次
3. 寫入 `MagicLinkAttempt`；驗證成功後由 `/api/auth/magic-link/verify` 更新 `success = true`。
4. 首次登入若 email 落在 `ADMIN_EMAILS` 列表，透過 Prisma hook 自動授予 `admin` 角色。

### API 中介層

- `middleware/auth.js`：確認 `request.user`，無 session 時回傳 401。
- `middleware/sanitize.js`：使用 DOMPurify 清洗請求內容，防範 XSS。

## 響應格式

`utils/response.js` 統一提供：

- `successResponse(data, message?)`
- `errorResponse(message, code?)`
- `serverErrorResponse(message)`

搭配 `app.js` 的 `setErrorHandler` 將 Fastify 驗證錯誤整合為 `{ success: false, error: { code, message, details } }`。

## 建議流程

1. 新增需要登入的路由時：
   - 匯入 `requireAuth`
   - 視情況檢查 `request.user.role`
2. 若擴充資料清洗需求，可於 `middleware/sanitize.js` 增加欄位白名單/黑名單。
3. 調整 CSP/Allowed Origins 時同步更新前端部署設定與 CDN。
