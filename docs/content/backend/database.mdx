---
title: 資料模型
description: Prisma schema 與關聯規則整理
---

Prisma schema (`backend/prisma/schema.prisma`) 採用 PostgreSQL，所有 Model 皆映射到既有的資料表，以下整理主要實體：

## 使用者與登入

- `User`
  - 欄位：`role`（`admin`、`eventAdmin`、`viewer`）、`permissions`（JSON 字串，儲存 eventAdmin 管理的活動）
  - 關聯：`Session`、`Account`、`Registration`、`EmailCampaign`、`SmsVerification`
  - 唯一約束：`email`
- `Session`
  - 存放 BetterAuth session token，`token` 欄位唯一
- `Account`
  - 預留第三方登入資料結構
- `Verification`
  - 通用驗證碼儲存區（尚未大幅使用）
- `MagicLinkAttempt`
  - 記錄魔術連結嘗試狀態，限制頻率（依 `lib/auth.js` 規則更新）

## 活動與票券

- `Event`
  - 使用 JSON 儲存多語欄位（`name`, `description`, `plainDescription`）
  - 關聯：`Ticket`, `Registration`, `EventFormFields`, `Referral`, `ReferralUsage`
- `Ticket`
  - 包含 `quantity`, `soldCount`, `saleStart`, `saleEnd`, `requireInviteCode`, `requireSmsVerification`
  - 關聯：`InvitationCode`, `Registration`
- `EventFormFields`
  - 自定義報名表欄位，`order` 決定排序，`filters` 儲存顯示條件

## 報名與推薦

- `Registration`
  - `@@unique([email, eventId])` 避免同活動重複報名
  - `formData` 使用 JSON 字串儲存表單答案
  - 與 `Referral` 建立雙向關係：一位報名者可推薦其他人
- `Referral`
  - 每位報名者最多一個推薦碼 (`registrationId` 唯一)
- `ReferralUsage`
  - 紀錄推薦碼被使用的報名紀錄，`@@unique([referralId, registrationId])`
- `InvitationCode`
  - 記錄票券邀請碼、使用次數、有效期間

## 行銷與通知

- `EmailCampaign`
  - 儲存郵件任務設定、排程與統計
- `SmsVerification`
  - 手機驗證碼紀錄，用於票券需簡訊驗證的流程

## 擴充建議

- 新增欄位後同步更新 `schemas/` 與前端 Types
- 需要快取的 Model 設定於 `config/database.js` 的 `auto.models`
- 若要支援多語字串型態，沿用目前 JSON 結構並於前端選擇對應語言顯示
