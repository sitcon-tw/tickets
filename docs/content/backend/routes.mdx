---
title: 路由與模組
description: Fastify 路由結構與常用端點一覽
---

## 註冊流程

`routes/index.js` 採用模組化註冊：

```text
/api          → routes/public.js
/api/admin    → routes/admin.js
/api/system   → routes/system.js
```

每個模組再細分子檔案並搭配 `schemas/` 的 OpenAPI 定義，保持型別與 Swagger 文件一致。

## 公開路由（`routes/public/`）

- `auth.js`：以 `requireAuth` 確認登入狀態，提供 `/api/auth/permissions` 取得角色、權限與能力清單。
- `events.js`：查詢活動資訊、報名表單欄位。配合 `schemas/event.js` 驗證查詢參數。
- `tickets.js`：提供票券列表、售票狀態、價格等資訊。
- `registrations.js`：登入後可建立與更新報名紀錄，支援邀請碼、推薦碼與表單資料寫入。
- `smsVerification.js`：提交手機號碼、驗證簡訊（若 `Ticket.requireSmsVerification = true`）。
- `referrals.js`：查詢推薦碼狀態與建立推薦關係。
- `invitationCodes.js`：驗證票券邀請碼是否有效。

## 管理後台（`routes/admin/`）

- `analytics.js`：統計報名數、票券銷售情形，常搭配圖表顯示於前端後台。
- `events.js`：活動 CRUD、表單欄位管理與上傳 OG 圖片。
- `tickets.js`：票種設定與開關，包含名額、隱藏狀態、邀請碼需求等欄位。
- `registrations.js`：檢索報名資料、更新狀態、標籤、匯出 CSV 等管理功能。
- `users.js`：調整使用者角色/權限、查詢登入紀錄。
- `invitationCodes.js`：批量產生邀請碼、匯入匯出。
- `referrals.js`：管理推薦碼及使用紀錄。
- `emailCampaigns.js`：建立寄送名單、預覽與派送郵件（依照 `utils/email.js`）。
- 其他檔案（如 `sms.js`, `system.js`）提供管理介面所需的輔助 API。

> 管理模組預設使用 `requireAuth` 並於 handler 內檢查角色；若新增需要 admin 權限的路由，記得沿用同樣的檢查流程。

## 系統路由（`routes/system.js`）

提供健康檢查、版本資訊或背景作業觸發點，供平台監控。

## 中介層與回應格式

- `middleware/auth.js`：透過 BetterAuth session 驗證，失敗回傳 401。
- `middleware/sanitize.js`：利用 DOMPurify 清除可能的 XSS 資料。
- `utils/response.js`：`successResponse`、`errorResponse` 格式統一回傳結構，利於前端解析。

## 新增路由建議

1. 於 `schemas/` 撰寫對應 schema，包含 `tags`、`description`、`response`。
2. 在模組中匯入 schema，於 Fastify 註冊時設定 `schema` 屬性。
3. 若需身份驗證或清洗資料，於 `preHandler` 引入中介層。
4. 針對計算密集步驟可使用 `withSpan('SpanName', fn)` 增加追蹤資訊。
